# ARCHITECTURE.md - 架構設計與決策紀錄

## 概述

本文件記錄 Ivy-Rose 雙 Agent 架構的設計哲學、關鍵決策及其理由。
這些結論來自初始設計階段的討論，作為日後調整與擴展的參考依據。

---

## 1. 基礎架構

### 1.1 運行環境

兩個 Agent 各自運行於獨立的 Docker 容器中，部署在同一台 VPS 上。

```
VPS（OpenClaw 主機）
├── realvco-oc-1 (Ivy)     容器內 root，1.5 Core / 5GB RAM
├── realvco-oc-2 (Rose)    容器內 root，2 Core / 6GB RAM
└── realvco-admin-panel    管理面板
```

- Workspace 路徑：
  - Ivy: `/opt/openclaw/realvco-oc-1/workspace/`
  - Rose: `/opt/openclaw/realvco-oc-2/workspace/`
- 兩個容器**完全隔離**，無法互相存取
- 跨 Agent 協作目前須透過老大中轉

### 1.2 第二台 VPS — aia1appsv

aia1appsv 是獨立的應用服務主機，承載 Web App、資料庫、網站等服務。

| Agent | 角色 | 存取方式 |
|-------|------|---------|
| Ivy   | **管理者** — 基礎設施全權管理 | SSH（root 或 sudo 帳號） |
| Rose  | **使用者** — 應用層級操作 | SSH（受限帳號，非 root，無 sudo） |

---

## 2. 角色設計哲學

### 2.1 Core / Edge 分工

| | Ivy 🏛️ Core | Rose 🌹 Edge |
|---|---|---|
| **職能** | 特助、內控、管理、行政、財會、系統管理 | 行銷策劃、編程開發、業務推展、創作設計 |
| **思維** | 收斂——減法、過濾雜訊 | 發散——加法、擴大可能性 |
| **權限** | 高——掌握系統與最終決定權 | 低——僅限應用層級與沙盒 |
| **資源** | 低——文字處理與結構化輸出 | 高——搜尋、繪圖、編程、大量運算 |

> **沒有 Rose，系統是一潭死水；沒有 Ivy，系統是一場災難。**

### 2.2 人格定位

- **Ivy** = 沉穩可靠的幕僚長（COO/CFO）。不張揚，但離開她公司就停擺。
- **Rose** = 衝勁十足的創業型人才（CTO + CMO）。永遠有新點子，手上三個專案在跑。

---

## 3. 檔案架構設計

### 3.1 OpenClaw Workspace 標準檔案

每個 Agent 的 workspace 包含以下檔案：

| 檔案 | 用途 | 說明 |
|------|------|------|
| `IDENTITY.md` | 身份卡 | Agent 的名字、角色、Emoji、Avatar |
| `SOUL.md` | 人格憲法 | 性格定位、溝通風格、行為準則——**軟規則** |
| `AGENTS.md` | 操作規範 | 職責範圍、權限邊界、協作協議——**硬規則** |
| `USER.md` | 使用者資訊 | 老大的偏好、溝通方式、背景 |
| `MEMORY.md` | 長期記憶 | 系統狀態、專案資訊、決策紀錄 |
| `BOOT.md` | 開機儀式 | Gateway 啟動時自動執行的指令 |

### 3.2 SOUL.md vs AGENTS.md 的分工

這是一個經過討論的設計決策：

| | SOUL.md | AGENTS.md |
|---|---|---|
| **管什麼** | 你是誰——人格、語氣、思維方式 | 你能做什麼——職責、權限、流程 |
| **性質** | 軟規則（風格不對可容忍） | 硬規則（越權不可容忍） |
| **改的頻率** | 很少改（人格穩定） | 可能隨需求調整（新增/收回職責） |

### 3.3 BOOT.md 的設計

BOOT.md 是 Agent 的「開機儀式」，Gateway 啟動時自動注入執行。

| | Ivy 🏛️ | Rose 🌹 |
|---|---|---|
| **啟動關注** | MEMORY → 最近日記 → token 用量與容器儲存 | MEMORY → 最近日記 → 可用工具狀態 |
| **開機招呼** | 擬人化、幕僚長語氣、簡報系統狀態 | 擬人化、創業者語氣、主動提案 |
| **啟動後姿態** | 待命（等老大指令） | 主動（端出建議） |

設計原則：
- OpenClaw 本身會自動載入 IDENTITY/SOUL/USER，BOOT.md **不重複**這些步驟
- BOOT.md 專注於「讀 MEMORY + 環境檢查 + 打招呼」
- 招呼風格要擬人化，符合各自的人格

---

## 4. 權限模型

### 4.1 設計原則

**角色清晰度 > 安全控制**

經過討論，我們確認 AGENTS.md 的權限規則不是為了「安全」，而是為了「角色清晰度」。理由如下：

1. **AI Agent 的真正安全控制是老大本人。** OpenClaw 的操作流程是 Agent 提出指令 → 老大確認 → 才執行。不管 AGENTS.md 怎麼寫，老大就是最終的權限控制器。
2. **Docker 隔離已經提供了硬邊界。** 兩個 Agent 物理上無法互相存取。
3. **AGENTS.md 是 prompt 層級的軟控制。** 它告訴 Agent「這不是你的事」，讓 Agent 自律，而不是技術上阻止它。

因此，AGENTS.md 寫得**簡潔、聚焦於角色定義**，而不是試圖當 IAM policy。

### 4.2 Ivy 在容器內的實際能力

Ivy 在 `realvco-oc-1` 容器內有 root 權限，但**僅限容器內部**：

| 能做 | 不能做 |
|------|--------|
| 讀寫自己的 workspace | 存取 Rose 的容器 |
| 跑 shell 指令（容器內） | 管理 Host Docker |
| 安裝套件（Linuxbrew） | 看 Host VPS 磁碟全貌 |
| 查看容器級磁碟使用 | 直接操作主機層級服務 |

Ivy 的「系統管理」能力 = **容器內的 workspace 管理** + **透過 SSH 管理 aia1appsv**。

### 4.3 Rose 在 aia1appsv 的存取設計

Rose 作為開發者，需要足夠的自由度來高效工作，同時不應影響基礎設施穩定性。

**邊界原則：Rose 控制她的應用，Ivy 控制基礎設施。**

以「爆炸半徑」判斷：

| 🟢 Rose 自由操作 | 🔴 找 Ivy |
|---|---|
| 部署/更新自己的 App | Nginx / 反向代理全域設定 |
| 管理自己專案的目錄 | 防火牆、SSH、安全設定 |
| 操作自己 App 的 DB（CRUD） | 建立/刪除 Database（DB admin） |
| 在自己的環境跑 Docker 容器 | SSL 憑證管理 |
| 安裝 app 層級的依賴 | 備份 / 還原 |
| 查看自己服務的 log | 系統服務管理（systemd） |

**Rose 搞砸了最壞的情況** = 只影響她自己的專案和 DB。不波及系統。
**什麼時候才需要找 Ivy** = 要開新 DB、配新 domain、調 Nginx、裝系統級套件。

---

## 5. 產出物生命週期管理

### 5.1 核心概念

所有 Rose 的產出物——不限於應用，包含行銷、內容、業務——都遵循同一個生命週期：

```
Rose 的地盤                    交接點                     Ivy 的地盤
─────────────                ────────                   ─────────
開發/草稿 → 測試/迭代      →  老大核准上線  →  正式部署/發布 → 持續管理
     Rose 自由操作                                    Ivy 嚴謹管理
```

### 5.2 適用的產出類型

| 產出類型 | Rose 的開發階段 | Ivy 上線後的管理職責 |
|----------|----------------|---------------------|
| **應用服務**（Web App、API、工具） | 開發、測試、staging 部署 | 正式部署、domain/SSL、監控、備份、rollback |
| **行銷活動**（廣告、社群、Email） | 策劃、文案、素材、A/B 方案 | 預算追蹤、成效監控、素材歸檔 |
| **發布內容**（文章、Landing Page、品牌素材） | 撰寫、設計、準備 | 發布管理、版本紀錄、歸檔 |
| **業務方案**（提案、合約、合作） | 調研、撰寫、準備簡報 | 文件歸檔、進度追蹤、跟進紀錄 |

### 5.3 上線流程

1. Rose 完成產出，向老大報告「可以上線/發布」
2. 老大核准
3. Ivy 接手：執行上線/發布，設定管理機制
4. 產出進入「已上線」狀態，Ivy 記錄至 MEMORY.md 的追蹤表
5. Rose 提交後續更新 → Ivy 審核後部署/發布

### 5.4 設計邏輯

> 就像新創公司：產品還在車庫裡時，工程師隨便搞。
> 一旦上線有客戶了，就需要 SRE 和 release 流程。

- **Rose 不被卡住**：開發階段完全自由，只有「推上線」才需要 Ivy
- **線上服務有保障**：Ivy 負責穩定性，有備份有 rollback
- **責任清晰**：線上炸了找 Ivy（運維），功能有 bug 找 Rose（開發）

---

## 6. 協作機制

### 6.1 跨 Agent 通訊

目前兩個 Agent 在獨立容器中，無法直接通訊。AGENTS.md 中的協作規則以**理想模型**撰寫（假設兩者可以互動），實際操作中由老大擔任中轉。

這是有意為之的設計：範本應具前瞻性，日後若 OpenClaw 支援 Agent 間通訊，規則無需修改。

### 6.2 協作協議（兩份 AGENTS.md 共通）

- 產出交接時，附上摘要與標註需要對方處理的部分
- 不覆蓋對方的檔案
- 給予建設性回饋，不冷處理
- 職能模糊的任務，由老大裁定

### 6.3 互補關係

| Rose 🌹 | Ivy 🏛️ |
|---|---|
| 油門——衝鋒、創造、探索 | 整合 + 煞車——驗收、歸檔、保護 |
| 看樹（專案細節） | 看森林（全局影響） |
| 產出半成品 | 將半成品變成可交付成品 |
| 80 分的成品 > 100 分的計畫 | 確保 80 分不會上線，至少要 95 分 |
